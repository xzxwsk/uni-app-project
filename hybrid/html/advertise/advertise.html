<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1">
		<title>广告启动页</title>
		<link rel="stylesheet" href="../css/advertise.css">
		<!-- uni 的 SDK -->
		<script type="text/javascript" src="../js/webView.js"></script>
	</head>
	<body>
		<div class="content">
			<div class="con" style="background-image: url(../imgs/loading.gif);">
				<img id="img" style="display: none; position: absolute; left: 0; top: 0; width: 100%; height: 100%; z-index: 2;">
			</div>
			<div class="btn" id="timer">
				<div id="info">跳过</div>
				<div class="circleProgress_wrapper btn">
					<div class="wrapper right">
						<div class="circleProgress rightcircle"></div>
					</div>
					<div class="wrapper left">
						<div class="circleProgress leftcircle"></div>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script>
		document.addEventListener('UniAppJSBridgeReady', function() {
			const methods = 'SYS.OptionsDAL.GetOptions';
			const ajaxFun = function(callback) {
				const baseUrl = 'http://118.163.201.227/qcdm/' + 'json.rpc/webapi';
				const xhr = new plus.net.XMLHttpRequest();
				xhr.onreadystatechange = function () {
					switch ( xhr.readyState ) {
						case 0:
							// console.log( "xhr请求已初始化" );
						break;
						case 1:
							// console.log( "xhr请求已打开" );
						break;
						case 2:
							console.log( "xhr请求已发送" );
						break;
						case 3:
							// console.log( "xhr请求已响应");
							break;
						case 4:
							if ( xhr.status == 200 ) {
								console.log( "xhr请求成功：" );
								// console.log(xhr.response);
								callback(xhr.response);
							} else {
								console.log( "xhr请求失败："+xhr.readyState );
							}
							break;
						default :
							break;
					}
				}
				xhr.responseType = 'json';
				xhr.open( "POST", baseUrl);
				xhr.send(JSON.stringify({
					jsonrpc: '2.0',
					method: methods,
					params: {},
					id: 1,
					tags: {
						usertoken: ''
					}
				}));
			}
			// 如果已有图片，则直接使用，等下载完成后再替换最新
			// const storagePath = localStorage.getItem('importpageimg')
			// console.log('storagePath: ', storagePath);
			// if (storagePath) {
			// 	plus.io.resolveLocalFileSystemURL(storagePath, function(entry) {
			// 		console.log('找到文件: ')
			// 		document.getElementById('img').style.backgroundSize = '100% 100%';
			// 		document.getElementById('img').style.backgroundImage = 'url(' + storagePath + ')';
			// 	}, function(err) {
			// 		console.log('未找到文件: ', JSON.stringify(err))
			// 	})
			// }
			// ajaxFun(function(res) {
			// 	if(res.hasOwnProperty('result')) {
			// 		const imgSrc = 'data:image/jpeg;base64,' + res.result.PictureSplashBase64;
			// 		document.getElementById('img').style.backgroundSize = '100% 100%';
			// 		document.getElementById('img').style.backgroundImage = 'url(' + imgSrc + ')';
			// 		// 获取下载完整路径
			// 		const downPath = plus.io.PUBLIC_DOWNLOADS;
			// 		// 下载完成后再替换最新
			// 		plus.io.requestFileSystem(downPath, function(fs) {
			// 			const downloadFullPath = fs.root.fullPath + 'importPageImg.png';
			// 			const bitmap = new plus.nativeObj.Bitmap("test");
			// 			bitmap.loadBase64Data(imgSrc, function() {
			// 				bitmap.save(downloadFullPath, {
			// 					overwrite: true,  // 是否覆盖
			// 					quality: 100  // 图片清晰度
			// 				}, imgInfo => {
			// 					console.log('图片信息', imgInfo.target, ' size: ', imgInfo.size/1023)
			// 					localStorage.setItem('importpageimg', imgInfo.target)
			// 					document.getElementById('img').setAttribute('src', imgInfo.target);
			// 					document.getElementById('img').style.display = '';
			// 					document.getElementById('img').style.position = 'absolute';
			// 					document.getElementById('img').style.width = '100%';
			// 					document.getElementById('img').style.height = '100%';
			// 					document.getElementById('img').style.zIndex = 2;
			// 					bitmap.clear()
			// 				}, e => {
			// 					console.log('下载图片失败', e)
			// 					bitmap.clear()
			// 				})
			// 			}, e => {
			// 				console.log('下载图片失败', e)
			// 				bitmap.clear()
			// 			})
			// 		})
			// 	}
			// })
			const downPatht = plus.io.PUBLIC_DOWNLOADS;
			// 显示图片
			const showImg = function() {
				try{
					const imgLocal = localStorage.getItem('importpageimg')
					console.log('imgLocal: ', imgLocal)
					if (imgLocal) {
						document.getElementById('img').setAttribute('src', imgLocal);
						document.getElementById('img').style.display = '';
					}
				}catch(e){
					console.log('错误信息：', err)
				}
			}
			// 如果找到下载文件，则删除后再下载
			const findFile = function(callback) {
				try {
					plus.io.requestFileSystem(downPatht, function(fs) {
						const downloadFullPath = fs.root.fullPath + 'importPageImg.gif';
						plus.io.resolveLocalFileSystemURL('file://' + downloadFullPath, function(entry) {
							console.log('找到下载到本地文件', entry.fullPath)
							// 先备份，再删除
							const pathArr = entry.fullPath.split('/')
							const path = pathArr.slice(0, pathArr.length - 1)
							console.log(path.join('/'))
							entry.copyTo(path.join('/'), null, function(moveSuccessEntry){
								console.log('拷贝图片成功')
							}, function(err) {
								console.log('拷贝图片失败：', JSON.stringify(err))
							})
							// 找到文件后，删除掉
							entry.remove(function() {
								console.log('删除成功：')
							}, function(err) {
								console.log('删除失败错误信息：', err)
							})
							callback && callback(entry.fullPath)
						}, function(err) {
							console.log('未找到下载到本地文件：', JSON.stringify(err))
							callback && callback(downloadFullPath)
						})
					})
				} catch(err) {
					console.log('错误信息：', err)
				}
			}
			// 保存图片
			const saveImg = function(entry, path) {
				// plus.io.getImageInfo({
				// 	src: entry.toLocalURL(),
				// 	success: function(e) {
				// 		console.log('获取图片信息成功：')
				// 	},
				// 	fail: function() {
				// 		console.log('获取图片信息失败')
				// 	}
				// })
				plus.io.requestFileSystem(downPatht, function(fs) {
					const downloadFullPath = fs.root.fullPath + '111.gif';
					console.log('load 图片之前', downloadFullPath)
					const bitmap = new plus.nativeObj.Bitmap("test");
					bitmap.load(path, function() {
						// 保存后只有一帧
						bitmap.save(downloadFullPath, {
							overwrite: true,  // 是否覆盖
							quality: 100  // 图片清晰度
						}, imgInfo => {
							console.log('加载图片后save图片信息: ', imgInfo.target, ' size: ', imgInfo.size/1023);
							let arr = imgInfo.target.split('/var')
							console.log(arr, entry.fullPath)
							if (plus.os.name == 'iOS') {
								// 获取下载路径后，把原始下载图片移到该位置
								try{
									console.log('源文件：：', entry.toRemoteURL())
									console.log('目标路径：', '/var' + arr[1] + fs.root.fullPath)
									// entry.file().copyTo('/var' + arr[1] + fs.root.fullPath, null, function(moveSuccessEntry) {
									// 	console.log('拷贝下载图片成功：', moveSuccessEntry.toLocalURL())
									// 	localStorage.setItem('importpageimg', moveSuccessEntry.toLocalURL())
									// }, function(err) {
									// 	console.log('拷贝下载图片失败：', JSON.stringify(err))
									// })
								}catch(e){
									console.log('拷贝图片：', e)
								}
							}
							// 保存后只有一帧
							bitmap.clear()
						}, e => {
							console.log('下载图片失败', e)
							bitmap.clear()
						})
					}, function(err) {
						console.log('加载图片失败：', JSON.stringify(err))
					})
				})
			}
			findFile(function(fullPath) {
				const picUrl = 'https://n.sinaimg.cn/tech/transform/366/w216h150/20210203/70ad-kirmait4625391.gif' // https://pic.fhtp88.com/upload/art/07/14/04/wgvnto2i2gt.jpg
				const option = {
					filename: fullPath
				}
				const dtask = plus.downloader.createDownload(picUrl, option, function (d, status) {
					// 下载完成
					if(status == 200){ 
						console.log("Download success: ", d.url, d.filename, d.totalSize/1024);
						// 下载完成后用下载路径替换
						// document.getElementById('img').setAttribute('src', picUrl);
						plus.io.resolveLocalFileSystemURL(d.filename, function(entry) {
							console.log('找到文件: ', entry.fullPath, entry.toLocalURL(), entry.toURL())
							// saveImg(entry, entry.toLocalURL())
							try{
								// const reader = new plus.io.FileReader();
								// reader.onloadend = function ( e ) {
								// 	plus.console.log( "Read success" );
								// 	// Get data
								// 	plus.console.log( e.target.result );
								// };
								// reader.onerror = function ( e ) {
								// 	plus.console.log( "Read error" );
								// 	plus.console.log( e );
								// }
								// reader.readAsDataURL( entry );
								
								// 与resolveLocalFileSystemURL获取的对象一样
								// fs.root.getFile(entry.fullPath, {}, function(fileEntry){
								// 	fileEntry.file( function ( file ) {
								// 		console.log('读取文件', fileEntry.fullPath)
								// 	}, function ( e ) {
								// 		console.log( e.message );
								// 	})
								// })
								// plus.gallery.save(entry.fullPath, function (e) {
								// 	console.log( "保存图片到相册成功", e.path );
								// })
							}catch(err){
								console.log('获取图片信息成功 错误信息：', err)
							}
						}, function(err) {
							console.log('未找到文件: ', JSON.stringify(err))
						})
						// 将本地URL路径转换成平台绝对路径
						// let absolute_image_path = plus.io.convertLocalFileSystemURL(d.filename);
						// console.log('absolute_image_path: ', absolute_image_path);
						// 将平台绝对路径转换成本地URL路径
						// let image_path = plus.io.convertAbsoluteFileSystem(entry.fullPath);
						// console.log('image_path: ', image_path);
					}else{
						console.log("Download failed: " + status); 
					}  
				})
				// dtask.addEventListener("statechanged", function(d, status) {
				// 	if (d.state === 3) {
				// 		console.log(Math.round(d.downloadedSize / d.totalSize * 100))
				// 	}
				// }, false);
				dtask.start();
			});
			
			document.querySelector('.btn').addEventListener('click', function(e) {
				if (e.hasOwnProperty('isTrusted') && e.isTrusted) {
					plus.webview.currentWebview().close();
					uni.getEnv(function(res) {
						console.log('当前环境：' + JSON.stringify(res));
					});
				} else if(!e.hasOwnProperty('isTrusted')){
					plus.webview.currentWebview().close();
					uni.getEnv(function(res) {
						console.log('当前环境：' + JSON.stringify(res));
					});
				}
			});
		});
	</script>
</html>
