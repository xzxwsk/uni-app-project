<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1">
		<title>广告启动页</title>
		<link rel="stylesheet" href="../css/advertise.css">
		<!-- uni 的 SDK -->
		<script type="text/javascript" src="../js/webView.js"></script>
	</head>
	<body>
		<div class="content">
			<div class="con" id="img" style="background-image: url(../imgs/loading.gif);">
				<!-- <img id="img" src="../imgs/advertise.jpg"> -->
			</div>
			<div class="btn" id="timer">
				<div id="info">跳过</div>
				<div class="circleProgress_wrapper btn">
					<div class="wrapper right">
						<div class="circleProgress rightcircle"></div>
					</div>
					<div class="wrapper left">
						<div class="circleProgress leftcircle"></div>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script>
		document.addEventListener('UniAppJSBridgeReady', function() {
			const methods = 'SYS.OptionsDAL.GetOptions';
			const ajaxFun = function(callback) {
				const baseUrl = 'http://118.163.201.227/qcdm/' + 'json.rpc/webapi';
				const xhr = new plus.net.XMLHttpRequest();
				xhr.onreadystatechange = function () {
					switch ( xhr.readyState ) {
						case 0:
							// console.log( "xhr请求已初始化" );
						break;
						case 1:
							// console.log( "xhr请求已打开" );
						break;
						case 2:
							console.log( "xhr请求已发送" );
						break;
						case 3:
							// console.log( "xhr请求已响应");
							break;
						case 4:
							if ( xhr.status == 200 ) {
								console.log( "xhr请求成功：" );
								// console.log(xhr.response);
								callback(xhr.response);
							} else {
								console.log( "xhr请求失败："+xhr.readyState );
							}
							break;
						default :
							break;
					}
				}
				xhr.responseType = 'json';
				xhr.open( "POST", baseUrl);
				xhr.send(JSON.stringify({
					jsonrpc: '2.0',
					method: methods,
					params: {},
					id: 1,
					tags: {
						usertoken: ''
					}
				}));
			}
			// 如果已有图片，则直接使用，等下载完成后再替换最新
			const storagePath = localStorage.getItem('importpageimg')
			console.log('storagePath: ', storagePath);
			// 平台绝对路径
            // let absolute_image_path = plus.io.convertLocalFileSystemURL(storagePath);
			// console.log('absolute_image_path: ', absolute_image_path);
			if (storagePath) {
				plus.io.resolveLocalFileSystemURL(storagePath, function(entry) {
					console.log('找到文件: ')
					document.getElementById('img').style.backgroundSize = '100% 100%';
					document.getElementById('img').style.backgroundImage = 'url(' + storagePath + ')';
				}, function(err) {
					console.log('未找到文件: ', JSON.stringify(err))
				})
			}
			
			ajaxFun(function(res) {
				if(res.hasOwnProperty('result')) {
					const imgSrc = 'data:image/jpeg;base64,' + res.result.PictureSplashBase64;
					document.getElementById('img').style.backgroundSize = '100% 100%';
					document.getElementById('img').style.backgroundImage = 'url(' + imgSrc + ')';
					// 获取下载完整路径
					const downPath = plus.io.PUBLIC_DOWNLOADS;
					// 下载完成后再替换最新
					plus.io.requestFileSystem(downPath, function(fs) {
						const downloadFullPath = fs.root.fullPath + 'importPageImg.png';
						const bitmap = new plus.nativeObj.Bitmap("test");
						bitmap.loadBase64Data(imgSrc, function() {
							bitmap.save(downloadFullPath, {
								overwrite: true,  // 是否覆盖
								quality: 100  // 图片清晰度
							}, imgInfo => {
								console.log('图片信息', imgInfo.target, ' size: ', imgInfo.size/1023)
								localStorage.setItem('importpageimg', imgInfo.target)
								bitmap.clear()
							}, e => {
								console.log('下载图片失败', e)
								bitmap.clear()
							})
						}, e => {
							console.log('下载图片失败', e)
							bitmap.clear()
						})
					})
				}
			})
			document.querySelector('.btn').addEventListener('click', function(e) {
				if (e.hasOwnProperty('isTrusted') && e.isTrusted) {
					plus.webview.currentWebview().close();
					uni.getEnv(function(res) {
						console.log('当前环境：' + JSON.stringify(res));
					});
				} else if(!e.hasOwnProperty('isTrusted')){
					plus.webview.currentWebview().close();
					uni.getEnv(function(res) {
						console.log('当前环境：' + JSON.stringify(res));
					});
				}
			});
		});
	</script>
</html>
